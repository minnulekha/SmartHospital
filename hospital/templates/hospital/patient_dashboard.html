<!DOCTYPE html>
<html>
<head>
    <title>Patient Dashboard</title>
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
    <style>
        body { background-color: #f0f2f5; height: 100vh; display: flex; align-items: center; justify-content: center; }
        .card-portal { max-width: 450px; width: 100%; border: none; border-radius: 20px; overflow: hidden; }
        .portal-header { background: #1a73e8; padding: 40px 20px; text-align: center; color: white; }
        .btn-google { background: white; color: #444; border: 1px solid #ddd; font-weight: 600; padding: 12px; display: flex; align-items: center; justify-content: center; gap: 10px; }
        #dashboard-actions { display: none; } /* Hidden until logged in */
    </style>
</head>
<body>

<div class="card shadow-lg card-portal">
    <div class="portal-header">
        <i class="fas fa-hospital-user fa-4x mb-3"></i>
        <h3 id="welcome-text">Patient Portal</h3>
        <p class="mb-0 text-white-50">Manage your hospital visit</p>
    </div>
    
    <div class="card-body p-4 bg-white">
        
        <div id="login-section">
            <p class="text-center text-muted mb-4">Please verify identity to access dashboard.</p>
            <button id="google-login-btn" type="button" class="btn btn-google w-100 rounded-pill shadow-sm">
                <img src="https://www.gstatic.com/firebasejs/ui/2.0.0/images/auth/google.svg" width="24">
                Continue with Google
            </button>
        </div>

        <div id="dashboard-actions">
            <div class="d-grid gap-3">
                <a href="{% url 'check_in' %}" class="btn btn-primary btn-lg rounded-pill shadow-sm py-3">
                    <i class="fas fa-plus-circle me-2"></i> Book New Token
                </a>

                <div class="text-center text-muted small py-2">- OR -</div>

                <form method="post">
                    {% csrf_token %}
                    <label class="fw-bold text-muted small ms-2 mb-1">ALREADY BOOKED?</label>
                    <div class="input-group">
                        <span class="input-group-text bg-light"><i class="fas fa-barcode"></i></span>
                        <input type="text" name="ticket_id" class="form-control" placeholder="e.g. 20250116-X7Z9" required>
                        <button type="submit" class="btn btn-dark">Track Status</button>
                    </div>
                    {% if error %}
                    <div class="alert alert-danger mt-3 small py-2 text-center">
                        <i class="fas fa-exclamation-circle me-1"></i> {{ error }}
                    </div>
                    {% endif %}
                </form>
            </div>
            
            <div class="text-center mt-4 border-top pt-3">
                <button id="logout-btn" class="btn btn-link text-danger btn-sm text-decoration-none">
                    <i class="fas fa-sign-out-alt"></i> Sign Out
                </button>
            </div>
        </div>

    </div>
</div>

<script type="module">
  import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
  import { getAuth, GoogleAuthProvider, signInWithPopup, onAuthStateChanged, signOut } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-auth.js";

  // YOUR KEYS
  const firebaseConfig = {
    apiKey: "AIzaSyAPZUgQM99l10PBbx0nXg4SuIZ_dhXp2Q4",
    authDomain: "smarthospital-63b2c.firebaseapp.com",
    projectId: "smarthospital-63b2c",
  };

  const app = initializeApp(firebaseConfig);
  const auth = getAuth(app);
  const provider = new GoogleAuthProvider();

  // Elements
  const loginSection = document.getElementById('login-section');
  const dashboardSection = document.getElementById('dashboard-actions');
  const welcomeText = document.getElementById('welcome-text');
  const googleBtn = document.getElementById('google-login-btn');
  const logoutBtn = document.getElementById('logout-btn');

  // 1. AUTO-CHECK LOGIN
  onAuthStateChanged(auth, (user) => {
      if (user) {
          showDashboard(user);
      }
  });

  // 2. LOGIN BUTTON
  googleBtn.addEventListener('click', () => {
    signInWithPopup(auth, provider)
      .then((result) => showDashboard(result.user))
      .catch((error) => alert(error.message));
  });

  // 3. LOGOUT BUTTON
  logoutBtn.addEventListener('click', () => {
    signOut(auth).then(() => location.reload());
  });

  // 4. SWITCH UI FUNCTION
  function showDashboard(user) {
    loginSection.style.display = 'none';
    dashboardSection.style.display = 'block';
    welcomeText.innerText = "Hi, " + user.displayName.split(' ')[0]; 
  }
</script>

</body>
</html>