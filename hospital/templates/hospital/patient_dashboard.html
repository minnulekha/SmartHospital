{% extends 'hospital/base.html' %}

{% block content %}
<div class="container d-flex align-items-center justify-content-center" style="min-height: 80vh;">
    
    <div class="card shadow-lg border-0 rounded-4" style="width: 100%; max-width: 500px; overflow: hidden;">
        
        <div class="portal-header text-center p-4" style="background: linear-gradient(135deg, #1a73e8, #0d47a1); color: white;">
            <i class="fas fa-hospital-user fa-4x mb-3"></i>
            <h3 id="welcome-text" class="fw-bold">Patient Portal</h3>
            <p class="mb-0 text-white-50">Manage your hospital visit</p>
        </div>
        
        <div class="card-body p-4 bg-white">
            
            <div id="login-section">
                <p class="text-center text-muted mb-3 small">Sign in to view your history and book tokens</p>
                <button id="google-login-btn" type="button" class="btn btn-outline-dark w-100 py-2 rounded-pill shadow-sm d-flex align-items-center justify-content-center gap-2">
                    <img src="https://www.gstatic.com/firebasejs/ui/2.0.0/images/auth/google.svg" width="20">
                    <span>Sign in with Google</span>
                </button>
                
                <div class="position-relative my-4">
                    <hr class="text-muted opacity-25">
                    <span class="position-absolute top-50 start-50 translate-middle bg-white px-3 text-muted small">OR</span>
                </div>
            </div>

            <div id="dashboard-actions" style="display: none;">
                <div class="d-grid gap-3 mb-4">
                    <a href="{% url 'patient_check_in' %}" class="btn btn-primary btn-lg rounded-pill shadow-sm py-3 fw-bold">
                        <i class="fas fa-plus-circle me-2"></i> Book New Token
                    </a>
                </div>

                <div class="mt-4">
                    <h6 class="fw-bold text-muted small mb-3 text-uppercase letter-spacing-1">My Appointment History</h6>
                    <div class="table-responsive">
                        <table class="table table-sm table-hover border-top">
                            <tbody id="history-list">
                                {% for app in history %}
                                <tr>
                                    <td class="py-2">
                                        <div class="fw-bold small">Dr. {{ app.doctor.user.first_name|default:app.doctor.user.username }}</div>
                                        <div class="text-muted" style="font-size: 0.7rem;">{{ app.booked_at|date:"d M Y" }}</div>
                                    </td>
                                    <td class="text-end py-2">
                                        <span class="badge rounded-pill {% if app.status == 'completed' %}bg-success{% else %}bg-warning text-dark{% endif %}" style="font-size: 0.65rem;">
                                            {{ app.status|title }}
                                        </span>
                                        {% if app.status != 'completed' %}
                                            <a href="{% url 'patient_live_status' app.id %}" class="d-block small text-primary mt-1" style="font-size: 0.65rem;">Track Live</a>
                                        {% endif %}
                                    </td>
                                </tr>
                                {% empty %}
                                <tr>
                                    <td colspan="2" class="text-center text-muted small py-3">No past appointments found.</td>
                                </tr>
                                {% endfor %}
                            </tbody>
                        </table>
                    </div>
                </div>

                <div class="text-center mt-3 pt-3 border-top">
                    <button id="logout-btn" class="btn btn-link text-danger btn-sm text-decoration-none fw-bold">
                        <i class="fas fa-sign-out-alt me-1"></i> Sign Out
                    </button>
                </div>
                <hr class="text-muted opacity-25 my-4">
            </div>

            <form method="post">
                {% csrf_token %}
                <label class="fw-bold text-muted small ms-1 mb-2">QUICK TRACK (ENTER TICKET ID)</label>
                <div class="input-group mb-2">
                    <span class="input-group-text bg-light border-end-0"><i class="fas fa-qrcode text-muted"></i></span>
                    <input type="text" name="ticket_id" class="form-control border-start-0" 
                           placeholder="e.g. 20251020-A1B2" 
                           style="text-transform: uppercase; letter-spacing: 1px;" required>
                    <button type="submit" class="btn btn-dark fw-bold px-4">Track</button>
                </div>
                
                {% if error %}
                <div class="alert alert-danger mt-3 small py-2 text-center rounded-3">
                    <i class="fas fa-exclamation-circle me-1"></i> {{ error }}
                </div>
                {% endif %}
            </form>

        </div>
    </div>
</div>

<script type="module">
  import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
  import { getAuth, GoogleAuthProvider, signInWithPopup, onAuthStateChanged, signOut } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-auth.js";

  const firebaseConfig = {
    apiKey: "AIzaSyAPZUgQM99l10PBbx0nXg4SuIZ_dhXp2Q4",
    authDomain: "smarthospital-63b2c.firebaseapp.com",
    projectId: "smarthospital-63b2c",
  };

  const app = initializeApp(firebaseConfig);
  const auth = getAuth(app);
  const provider = new GoogleAuthProvider();

  const loginSection = document.getElementById('login-section');
  const dashboardSection = document.getElementById('dashboard-actions');
  const welcomeText = document.getElementById('welcome-text');
  const googleBtn = document.getElementById('google-login-btn');
  const logoutBtn = document.getElementById('logout-btn');

  onAuthStateChanged(auth, (user) => {
      if (user) {
          showDashboard(user);
      } else {
          showLogin();
      }
  });

  googleBtn.addEventListener('click', () => {
    signInWithPopup(auth, provider)
      .then((result) => showDashboard(result.user))
      .catch((error) => console.error(error.message));
  });

  logoutBtn.addEventListener('click', () => {
    signOut(auth).then(() => {
        window.location.href = window.location.pathname;
    });
  });

  function showDashboard(user) {
    loginSection.style.display = 'none';
    dashboardSection.style.display = 'block';
    welcomeText.innerText = "Hi, " + user.displayName.split(' ')[0] + "!"; 

    // Redirect with email to fetch history if the URL doesn't have it yet
    const urlParams = new URLSearchParams(window.location.search);
    if (urlParams.get('email') !== user.email) {
        window.location.search = `?email=${encodeURIComponent(user.email)}`;
    }
  }

  function showLogin() {
    loginSection.style.display = 'block';
    dashboardSection.style.display = 'none';
    welcomeText.innerText = "Patient Portal";
  }
</script>
{% endblock %}